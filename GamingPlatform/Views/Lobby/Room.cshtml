@model GamingPlatform.Models.GameLobby
@{
    var currentPlayer = ViewBag.PlayerName as string;
}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salle d'attente - @Model.Name</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .card {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>Salle d'attente: @Model.Name</h1>
            <p class="text-muted">Jeu: @Model.GameType</p>
        </div>

        <div class="card p-4 mb-4" style="max-width: 600px; margin: 0 auto;">
            <h3>Joueurs (<span id="playerCount">@Model.Players.Count</span>/@Model.MaxPlayers)</h3>
            <ul id="playerList" class="list-group list-group-flush mt-3">
                @foreach (var player in Model.Players)
                {
                    <li class="list-group-item bg-transparent text-light border-secondary">
                        <i class="fa-solid fa-user"></i> @player
                    </li>
                }
            </ul>

            @if (Model.HostName == currentPlayer)
            {
                <div class="mt-4 text-center">
                    <button id="startGameBtn" class="btn btn-success btn-lg" @(Model.Players.Count < 2 ? "disabled" : "")>
                        <i class="fa-solid fa-play"></i> Démarrer la partie
                    </button>
                    <p id="waitingMsg" class="text-muted mt-2 @(Model.Players.Count < 2 ? "" : "d-none")">En attente d'autres joueurs...</p>
                </div>
            }
            else
            {
                <div class="mt-4 text-center">
                    <p class="text-info">En attente que l'hôte démarre la partie...</p>
                </div>
            }
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.4/signalr.min.js"></script>
    <script>
        const lobbyId = '@Model.Id';
        const gameType = '@Model.GameType';
        const currentPlayer = '@currentPlayer';
        
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/lobbyHub")
            .withAutomaticReconnect()
            .build();

        connection.start().then(() => {
            console.log("Connected to LobbyHub");
            connection.invoke("JoinLobbyGroup", lobbyId);
        }).catch(err => console.error(err));

        connection.on("PlayerJoined", (playerName) => {
            const list = document.getElementById("playerList");
            const li = document.createElement("li");
            li.className = "list-group-item bg-transparent text-light border-secondary";
            li.innerHTML = `<i class="fa-solid fa-user"></i> ${playerName}`;
            list.appendChild(li);
            
            const countSpan = document.getElementById("playerCount");
            const currentCount = parseInt(countSpan.textContent) + 1;
            countSpan.textContent = currentCount;

            const startBtn = document.getElementById("startGameBtn");
            const waitingMsg = document.getElementById("waitingMsg");
            
            if (startBtn && currentCount >= 2) {
                startBtn.disabled = false;
                if(waitingMsg) waitingMsg.classList.add("d-none");
            }
        });

        connection.on("GameStarted", (type) => {
            if (type === "Morpion") {
                window.location.href = `/Morpion/Game/${lobbyId}/${currentPlayer}`;
            } else if (type === "SpeedTyping") {
                window.location.href = `/SpeedTyping/Game/${lobbyId}`;
            } else if (type === "Puissance4") {
                window.location.href = `/Puissance4/Game/${lobbyId}/${currentPlayer}`;
            }
        });

        const startBtn = document.getElementById("startGameBtn");
        if (startBtn) {
            startBtn.addEventListener("click", () => {
                connection.invoke("StartGame", lobbyId);
            });
        }
    </script>
</body>
</html>
